\documentclass[border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,positioning,shadows,fit}

\begin{document}

\tikzset{
	repository/.style={
		rectangle,
		draw,
		fill=blue!20,
		text width=5.0cm,
		text centered,
		minimum height=1.8cm,
		rounded corners,
		drop shadow,
		font=\bfseries
	},
	component/.style={
		ellipse,
		draw,
		fill=green!20,
		text width=3.0cm,
		text centered,
		minimum height=1.2cm,
		drop shadow
	},
	infrastructure/.style={
		rectangle,
		draw,
		fill=orange!20,
		text width=3.2cm,
		text centered,
		minimum height=1.2cm,
		rounded corners,
		drop shadow
	},
	redis_layer/.style={
		rectangle,
		draw,
		fill=red!10,
		dashed,
		thick,
		text width=12cm,
		minimum height=6cm,
		rounded corners
	},
	arrow/.style={
		->,
		>=stealth,
		thick
	},
	bidirectional/.style={
		<->,
		>=stealth,
		thick
	},
	label/.style={
		font=\small,
		text width=2.8cm,
		text centered
	}
}

\begin{tikzpicture}[node distance=2.5cm and 3cm]

  % ============================================================
  % CENTER: Redis Layer
  % ============================================================

  \node[redis_layer] (redis_layer) at (0,0) {};
  \node[above left=0.1cm and 1.5cm of redis_layer.north, font=\large\bfseries] {redis\_robot\_comm};

  % Redis Streams (ellipses inside the layer)
  \node[component] (redis_images) at (redis_layer.center) [xshift=3.0cm, yshift=1.4cm] {Redis Stream\\robot\_camera\\(Images)};
  \node[component] (redis_labels) at (redis_layer.center) [xshift=-3.0cm, yshift=1.4cm] {Redis Stream\\detectable\_labels\\(Labels)};
  \node[component] (redis_objects) at (redis_layer.center) [xshift=-3.0cm, yshift=-1.4cm] {Redis Stream\\detected\_objects\\(Detections)};
  \node[component] (redis_annotated) at (redis_layer.center) [xshift=3.0cm, yshift=-1.4cm] {Redis Stream\\annotated\_camera\\(Annotations)};

  % ============================================================
  % TOP LEFT: MCP Client
  % ============================================================

  \node[repository, above left=4.5cm and 2cm of redis_layer.north] (mcp_client) {robot\_mcp\\MCP Client\\(LLM Interface)};

  % ============================================================
  % TOP RIGHT: MCP Server with Robot Components
  % ============================================================

  \node[repository, above right=4.5cm and 2cm of redis_layer.north] (mcp_server) {robot\_mcp\\MCP Server};

  \node[repository, below=0.5cm of mcp_server] (robot_env) {robot\_environment};
  \node[repository, right=0.9cm of robot_env, text width=3.5cm] (robot_ws) {robot\_workspace};
  \node[repository, right=0.9cm of robot_ws, text width=3.5cm] (text2speech) {text2speech};

  % Robot pictogram (simplified)
  \node[above right=-1.8cm and 2.5cm of mcp_server] (robot_pic) {
    \begin{tikzpicture}[scale=0.8]
      % Base
      \draw[fill=gray!30, thick] (-0.5,0) rectangle (0.5,0.3);
      % Column
      \draw[fill=gray!40, thick] (-0.2,0.3) rectangle (0.2,1.5);
      % Arm segments
      \draw[fill=gray!50, thick, rounded corners] (0.2,1.3) -- (1.2,1.5) -- (1.2,1.7) -- (0.2,1.5) -- cycle;
      \draw[fill=gray!50, thick, rounded corners] (1.2,1.6) -- (1.8,1.0) -- (2.0,1.1) -- (1.4,1.7) -- cycle;
      % Gripper
      \draw[fill=gray!60, thick] (1.8,0.9) -- (1.7,1.1) -- (1.9,1.1) -- cycle;
      \draw[fill=gray!60, thick] (1.8,1.1) -- (1.7,1.3) -- (1.9,1.3) -- cycle;
    \end{tikzpicture}
  };

  % ============================================================
  % BOTTOM LEFT: Vision Detection Script
  % ============================================================

  \node[repository, below left=2.5cm and 2cm of redis_layer.south] (vision_script) {vision\_detect\_segment\\detect\_objects\_publish\_annotated\_frames.py};

  % ============================================================
  % BOTTOM RIGHT: Visualization Script
  % ============================================================

  \node[repository, below right=2.5cm and 4cm of redis_layer.south] (viz_script) {redis\_robot\_comm\\visualize\_annotated\_frames.py};

  % ============================================================
  % ARROWS: Data Flow
  % ============================================================

  % MCP Client <-> MCP Server (commands)
  \draw[bidirectional] (mcp_client.east) -- node[above, label, sloped] {Tool Calls\\Results} (mcp_server.west);
  \draw[bidirectional] (mcp_server.south) -- (robot_env.north);

  \draw[bidirectional] (robot_pic.west) -- node[above=0.5cm, label] {Raw Frames\\Commands} (robot_env.north east);

  % MCP Server -> Redis (image requests)
  \draw[arrow] (robot_env.south) -- node[right, label] {Publish\\Raw Frames} (redis_images.north);
  \draw[arrow] (robot_env.east) -- (robot_ws.west);
  \draw[bidirectional] (robot_env.west) -- node[above left=0.0cm and 0.0cm, label] {Receive/Update\\Detectable Objects} (redis_labels.north east);
  \draw[arrow] (robot_env.south east) to[bend right=20] node[below, label] {Command} (text2speech.south west);

  % MCP Server <- Redis (object data)
  \draw[arrow] (redis_objects.north east) -- node[above right=1.0cm and 0.2cm, label] {Receive\\Detections} (robot_env.south west);

  % Vision Script -> Redis (images in, objects out)
  \draw[arrow] (redis_images.south west) -- node[below left=1.0cm and 0.5cm, label] {Subscribe\\Raw Frames} (vision_script.north east);
  \draw[arrow] (vision_script.north) -- node[left=-0.4, label] {Publish\\Detections} (redis_objects.south);
  \draw[arrow] (vision_script.west) -- ++(-0.6,0.0) |- node[above, label] {Publish\\Detectable\\Objects} (redis_labels.west);

  % Vision Script -> Redis (annotated frames)
  \draw[arrow] (vision_script.east) -- node[right, label] {Publish\\Annotated Frames} (redis_annotated.south);

  % Visualization Script <- Redis (annotated frames)
  \draw[arrow] (redis_annotated.south east) -- node[right, label] {Subscribe\\Annotated Frames} (viz_script.north);

  % ============================================================
  % Group Boxes
  % ============================================================

  \node[draw, dashed, thick, fit=(mcp_server) (robot_env) (robot_ws) (robot_pic) (text2speech),
  inner sep=0.5cm] (server_group) {};
  \node[above=0.1cm of server_group] {\textbf{Robot Control}};

  % ============================================================
  % Legend
  % ============================================================

  \node[above right=0.3cm and 2.0cm of redis_layer.east] (legend_title) {\textbf{Legend:}};

  \node[repository, right=0.5cm of legend_title, minimum height=0.8cm, text width=2.2cm] (leg_repo) {\small Package/ Script};
  \node[component, right=0.3cm of leg_repo, minimum height=0.8cm, text width=2.0cm] (leg_comp) {\small Component};
  \node[infrastructure, below=0.3cm of leg_comp, minimum height=0.8cm, text width=2.0cm] (leg_infra) {\small Redis Stream};

  % Arrow legend
  \draw[arrow] ([yshift=-0.8cm]legend_title.south) -- ++(1.5,0) node[right, font=\small] {Data Flow};
  \draw[bidirectional] ([yshift=-1.2cm]legend_title.south) -- ++(1.5,0) node[right, font=\small] {Bidirectional};

\end{tikzpicture}

\end{document}
